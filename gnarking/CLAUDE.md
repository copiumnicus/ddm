# CLAUDE.md - AI Development Context

## Project Overview

**gnarking** is a zero-knowledge proof system for batch settlement verification using Groth16 SNARKs. It demonstrates how to compress and verify multiple transactions with EdDSA signatures into a single cryptographic proof that can be verified on Ethereum/Arbitrum.

**Key Value Proposition:** Compress 8 transactions into a single proof, achieving ~16x calldata compression and ~$0.009/batch verification cost on Arbitrum One.

## Technology Stack

### Backend (Zero-Knowledge Proofs)
- **Go 1.25.3** - Primary language
- **gnark v0.14.0** - Circuit definition framework
- **gnark-crypto v0.19.0** - Cryptographic primitives
- **Groth16** - ZK proof system (fastest verification)
- **BN254 curve** - Elliptic curve for pairing-based cryptography
- **EdDSA** - Signature scheme on twisted Edwards curve
- **MiMC** - SNARK-friendly hash function (~7000x cheaper than SHA256 in circuits)

### Frontend (Blockchain)
- **Solidity ^0.8.13** - Smart contract language
- **Foundry** - Development framework (forge, cast)
- **Arbitrum One** - Deployment target (L2)

### Tooling
- **Python 3** - Test generation (`make_test.py`)
- **Bash** - Deployment scripts (`tx.sh`)

## Architecture

### Circuit Parameters
- **Batch Size:** N = 8 transactions per proof
- **Curve:** BN254 (optimal for Ethereum)
- **Hash Function:** MiMC with domain separator "msettle1"
- **Signature Scheme:** EdDSA on twisted Edwards BN254

### Public Inputs (7 field elements)
1. `Recipient` - Settlement recipient address
2. `KOld` - Old nonce/checkpoint
3. `M` - New maximum nonce
4. `TotalSettle` - Sum of all transaction sizes
5. `ChainID` - Blockchain identifier
6. `PublicKey.X` - EdDSA public key X coordinate
7. `PublicKey.Y` - EdDSA public key Y coordinate

### Private Inputs (per transaction, N=8)
- `Size` - Transaction amount
- `Nonce` - Transaction nonce (must be strictly increasing)
- `Signature.R.X, R.Y` - EdDSA signature R point
- `Signature.S` - EdDSA signature S scalar

## Critical Files

### Core Circuit Logic
- **`circuit/settlement.go:1`** - Main settlement circuit
  - Defines `SettlementCircuit` struct with N=8 batch
  - `Define()` method contains all circuit constraints
  - Verifies EdDSA signatures, nonce ordering, total calculation

- **`circuit/settlement_util.go:1`** - Native MiMC utilities
  - `NewNativeMiMC()` - Creates native MiMC hasher
  - `HashSettle()` - Computes settlement message hash (matches circuit)
  - Domain separator: "msettle1"

- **`circuit/settlement_test.go:1`** - Comprehensive circuit tests
  - `TestSettlement()` - Valid witness test
  - `TestSettlement_Invalid*()` - Constraint violation tests

### Command-Line Applications
- **`cmd/settlement_demo/main.go:1`** - Main entry point
  - `--setup`: Compile circuit, generate proving/verifying keys, export Solidity
  - `--prove`: Generate proof from 8 transactions
  - `--verify`: Verify proof off-chain
  - Reports economics and compression stats

- **`cmd/eddsa_demo/main.go:1`** - Simple EdDSA demo

### Solidity/Foundry
- **`ddn/src/settlement_verifier_8.sol:1`** - Generated Groth16 verifier (585 lines)
  - Auto-generated by gnark, DO NOT EDIT MANUALLY
  - Contains pairing precompiles and verification logic

- **`ddn/test/settlement_verifier_8.sol:1`** - Foundry test
  - Generated by `make_test.py` from actual proof data
  - Tests on-chain verification with real proofs

- **`ddn/script/verify.s.sol:1`** - Foundry deployment script

- **`ddn/tx.sh:1`** - Arbitrum deployment script
  - Deploys verifier and runs on-chain verification
  - Current deployment: `0x3a197a1aea1035b8952cf6e29b0bb342e2199ce0`

### Build Artifacts (gitignored)
- **`artifact/`** - Generated files
  - `*.groth16` - Binary proving keys, verifying keys, proofs
  - `*.json` - Proof data and public inputs
  - `*.sol` - Generated Solidity verifiers

## Development Workflow

### 1. Circuit Development
```bash
# Modify circuit logic
vim circuit/settlement.go

# Run circuit tests
go test ./circuit/... -v

# Compile and generate keys
go run ./cmd/settlement_demo --setup
```

### 2. Proof Generation
```bash
# Generate a proof with valid witness
go run ./cmd/settlement_demo --prove

# Verify off-chain
go run ./cmd/settlement_demo --verify
```

### 3. Solidity Integration
```bash
# Generate Foundry test from proof
python make_test.py

# Run Foundry tests
cd ddn
forge test -vvv

# Deploy to Arbitrum
./tx.sh
```

## Common Tasks

### Modifying Batch Size
To change from N=8 to a different batch size:

1. Update `circuit/settlement.go:18`:
   ```go
   const N = 16  // Change to desired size
   ```

2. Regenerate everything:
   ```bash
   go test ./circuit/...                    # Verify constraints
   go run ./cmd/settlement_demo --setup     # Regenerate keys
   go run ./cmd/settlement_demo --prove     # Test proving
   python make_test.py                      # Update Solidity tests
   ```

3. Rename files to match (e.g., `settlement_verifier_16.sol`)

### Adding New Constraints
When modifying `circuit/settlement.go`:

1. **Add constraint** in `Define()` method
2. **Update witness generation** in test/prove code
3. **Run tests** to verify constraint satisfaction
4. **Document** the constraint's purpose in comments

### Debugging Circuit Failures
```bash
# Enable verbose constraint checking
go test ./circuit/... -v -count=1

# Check constraint violations
# Error messages show which constraint failed
```

### Updating Dependencies
```bash
# Update gnark
go get -u github.com/consensys/gnark@latest
go get -u github.com/consensys/gnark-crypto@latest
go mod tidy
```

## Important Considerations

### Security
- **Domain Separation:** Always use "msettle1" domain separator in hashes to prevent replay attacks
- **Nonce Ordering:** Circuit enforces strictly increasing nonces (prevents double-spending)
- **Signature Verification:** All transactions must be signed by the same EdDSA key
- **Chain ID:** Included in public inputs to prevent cross-chain replays

### Performance
- **Circuit Complexity:** ~7,000 constraints per signature verification
- **Proving Time:** ~0.5-2 seconds on modern CPU
- **Verification Time:** ~5ms off-chain, ~300k gas on-chain
- **MiMC rounds:** Tuned for BN254 security level

### Circuit Design Patterns
1. **Use SNARK-friendly primitives:** MiMC instead of SHA256, EdDSA instead of ECDSA
2. **Batch operations:** Amortize fixed costs across N transactions
3. **Public input minimization:** Only 7 public inputs for 8 transactions
4. **Native utilities:** Provide Go implementations matching circuit behavior (see `settlement_util.go`)

### Testing Strategy
- **Unit tests:** Each constraint in isolation (`circuit/*_test.go`)
- **Integration tests:** Full prove/verify cycle (`cmd/settlement_demo`)
- **On-chain tests:** Foundry tests with real proofs (`ddn/test/`)
- **Invalid witness tests:** Verify constraint violations are caught

## Useful Resources

### gnark Documentation
- **Circuits:** https://docs.gnark.consensys.io/Concepts/circuits
- **MiMC:** https://docs.gnark.consensys.io/HowTo/hash
- **EdDSA:** https://docs.gnark.consensys.io/HowTo/eddsa

### Key Concepts
- **Groth16:** Trusted setup, constant-size proofs, fastest verification
- **BN254:** Pairing-friendly curve, optimal for Ethereum precompiles
- **R1CS:** Rank-1 Constraint System (gnark's constraint representation)
- **Witness:** Private + public inputs satisfying the circuit

### Economics
- **Cost per proof:** ~$0.000003 (off-chain proving)
- **On-chain verification:** ~$0.009 (Arbitrum One)
- **Compression ratio:** ~16x vs naive calldata
- **Break-even:** Worthwhile for batches of 3+ transactions

## Current Deployment

**Network:** Arbitrum One
**Verifier Contract:** `0x3a197a1aea1035b8952cf6e29b0bb342e2199ce0`
**Batch Size:** N = 8 transactions
**Status:** Production-ready

## Repository Structure Reference

```
gnarking/
├── circuit/           # ZK circuit definitions and tests
├── cmd/              # Executable applications
├── artifact/         # Generated files (gitignored)
├── ddn/              # Foundry/Solidity project
│   ├── src/         # Solidity verifier contracts
│   ├── test/        # Foundry tests
│   ├── script/      # Deployment scripts
│   └── lib/         # Dependencies (forge-std)
├── go.mod           # Go module definition
├── make_test.py     # Test generator
└── CLAUDE.md        # This file
```

---

**Last Updated:** 2025-11-19
**Go Version:** 1.25.3
**gnark Version:** v0.14.0
